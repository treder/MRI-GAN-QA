# MRI-GAN-QA

Data and code accompanying the paper [INSERT PAPER LINK].

# Installation

Clone the repo and install the following packages:

- `tensorflow` (v2)
- `tensorflow_probability`
- `PIL`
- `opencv`
- `scipy`
- `numpy`
- `pandas`
- `openpyxl`
- `statsmodels`
- `scikit-learn`
- `jupyter`
- `matplotlib`
- `seaborn`
- `tqdm`

### Structure of the repo

The repository contains the following folders

- [`camcan_data`](/camcan_data): real and generated grey-matter (GM) density maps 
- [`experiment`](/experiment): data, images and scripts relating to the behavioral experiment
- [`results`](/results): results of the main analysis of the behavioral data and the metrics
- [`scripts`](/scripts): training and inference code for the Deep QA model and Jupyter notebooks with metrics and behavioral analyses
- [`videos`](/videos): videos illustrating the images generated by the WGAN

# CamCAN data

The folder [`camcan_data`](/camcan_data) contains grey-matter density maps for real images used to train the GAN. Additionally, it contains images generated by the GAN for five different iterations ranging from early to late stages of training. Each `.npy` file represents an individual MRI and is provided as a 3D Numpy array. To view them in a MRI viewer such as MRIcroGL they have to be converted to Nifti images using e.g. the [NiBabel](https://nipy.org/nibabel/gettingstarted.html) package.

# Experiment 

The [`experiment`](/experiment) folder contains data, images and scripts relating to the behavioral experiment. It contains the subfolder [`Psytoolkit`](/experiment/Psytoolkit) is a download from the [PsyToolkit website](https://www.psytoolkit.org/) with all the Psytoolkit scripts. The Psytoolkit folder also contains the subset of images in the [`experiment`](/experiment) folder that were used in the behavioral experiment. 

The raw behavioral data is contained in the [`experiment/data`](/experiment/data) folder. For the analysis of the behavioral data refer to the Jupyter notebook [`analyze_psytoolkit_data.ipynb`](scripts/analyze_psytoolkit_data.ipynb).

# Scripts

Training and inference code for the Deep QA model and Jupyter notebooks showing the analyses of the metrics and behavioral data. 
The Deep QA model is trained by running 

```
python DeepQA_train.py
```

It reads the behavioral data, extracts the empirical distibution of ratings for the images, and trains on the probabilistic labels. Set `train_detection_model = True` ([l.325](/scripts/DeepQA_train.py#L325)) to also train the detection model from scratch. You may need to adapt the file paths accordingly (ll. 23-26). The script can be taken as a starting point further improvements using data augmentation, merging with other datasets, or semi-supervised learning.

For inference, run `DeepQA_inference.py`. Given an input folder with images, the output is a `csv` file with the logits (for each of the five items on the rating scale) and the predicted rating (=arg max of the logits).

```
python DeepQA_inference.py --model_dir /path/to/model/ --image_dir /path/to/test/images
```

See [l.29-34](/scripts/DeepQA_inference.py#L29-L34) for additional command line parameters. 



